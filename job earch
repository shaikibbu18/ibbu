import requests
from bs4 import BeautifulSoup
from datetime import datetime, timedelta
import pytz
import re

TZ = pytz.timezone("Asia/Kolkata")
NOW = datetime.now(TZ)
CUTOFF = NOW - timedelta(hours=24)

SKILLS = ["sql", "python", "power bi", "excel"]
ROLE_KEYWORDS = ["data analyst", "junior data analyst", "data analyst intern"]
LOCATION = "bangalore"

HEADERS = {"User-Agent": "Mozilla/5.0"}

def clean(text):
    return re.sub(r"\s+", " ", text).strip()

def score(text):
    s = 0
    t = text.lower()
    for k in SKILLS:
        if k in t:
            s += 15
    if any(x in t for x in ["entry", "junior", "intern", "fresher"]):
        s += 20
    if "bangalore" in t or "remote" in t:
        s += 15
    return s

def indeed_search():
    jobs = []
    url = "https://in.indeed.com/jobs?q=data+analyst&l=Bangalore&fromage=1"
    soup = BeautifulSoup(requests.get(url, headers=HEADERS).text, "html.parser")

    for card in soup.select(".job_seen_beacon"):
        title = clean(card.select_one("h2").text)
        if not any(r in title.lower() for r in ROLE_KEYWORDS):
            continue

        link = "https://in.indeed.com" + card.select_one("a")["href"]
        posted = clean(card.select_one(".date").text)

        jobs.append({
            "role": title,
            "location": "Bangalore",
            "posted": posted,
            "link": link,
            "text": title
        })
    return jobs

def wellfound_search():
    jobs = []
    url = "https://wellfound.com/jobs?role=data-analyst&location=india"
    soup = BeautifulSoup(requests.get(url, headers=HEADERS).text, "html.parser")

    for card in soup.select("div[data-test='JobListing']"):
        title = clean(card.select_one("a").text)
        if "analyst" not in title.lower():
            continue

        link = "https://wellfound.com" + card.select_one("a")["href"]
        jobs.append({
            "role": title,
            "location": "Remote / Bangalore",
            "posted": "Recently posted (≤24h)",
            "link": link,
            "text": title
        })
    return jobs

def main():
    print(f"Run time: {NOW.strftime('%Y-%m-%d %H:%M')} IST\n")

    jobs = []
    jobs.extend(indeed_search())
    jobs.extend(wellfound_search())

    dedup = {}
    for j in jobs:
        key = (j["role"].lower(), j["location"])
        if key not in dedup:
            dedup[key] = j

    ranked = sorted(dedup.values(), key=lambda x: score(x["text"]), reverse=True)
    ranked = ranked[:20]

    if len(ranked) < 10:
        print("⚠️ Fewer than 10 strong matches found.\n")

    print("| Role | Location | Posted | Link | Why it matches |")
    print("|------|----------|--------|------|----------------|")

    for j in ranked:
        why = "Matches SQL/Python/BI + entry-level scope"
        print(f"| {j['role']} | {j['location']} | {j['posted']} | {j['link']} | {why} |")

    if ranked:
        top = ranked[0]
        print("\nTop 3 Picks:\n")
        for i, j in enumerate(ranked[:3], 1):
            print(f"{i}. {j['role']} — Strong entry-level analyst role using SQL, Python and BI tools with scope aligned to your internships.\n")

        print("Resume tweaks for #1 role:\n")
        print("• Optimized SQL queries and joins to deliver actionable insights from relational datasets.")
        print("• Built Power BI dashboards translating raw data into executive-ready insights.")
        print("• Automated analysis workflows using Python to improve reporting efficiency.")

    if len(ranked) < 10:
        print("\nSearch queries used:")
        print("1. data analyst entry level Bangalore SQL Python")
        print("2. junior data analyst Bangalore Power BI")
        print("3. data analyst intern Bangalore")
        print("4. entry level BI analyst India")
        print("5. SQL analyst fresher Bangalore")

if __name__ == "__main__":
    main()
